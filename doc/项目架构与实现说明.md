# Note to RED 项目架构与实现说明

## 1. 项目定位
Note to RED 是一个 Obsidian 桌面端插件，用于将 Markdown 笔记按标题切分并渲染成小红书风格图片，支持主题、模板、字体、背景、批量导出与复制。

- 插件入口：`src/main.ts`
- 视图类型：`note-to-red`（右侧自定义面板）
- 目标平台：桌面端（`manifest.json` 中 `isDesktopOnly: true`）

## 2. 技术栈与构建体系

### 2.1 主要技术栈
- 语言：TypeScript（`tsconfig.json`）
- 运行环境：Obsidian Plugin API
- 打包工具：esbuild（`esbuild.config.mjs`）
- 图像导出：`html-to-image`
- 批量压缩：`jszip`

### 2.2 构建输出
- JS 入口：`src/main.ts` -> `main.js`
- CSS 入口：`src/styles/index.css` -> `styles.css`
- 开发模式：`npm run dev`（watch 模式）
- 生产构建：`npm run build`

### 2.3 发布打包
`build.sh` 会将 `main.js`、`manifest.json`、`styles.css`、`assets/` 复制到临时目录并打 zip。

## 3. 运行时总体架构

### 3.1 分层
- 插件生命周期层：`RedPlugin`（`src/main.ts`）
- 视图交互层：`RedView`（`src/view.ts`）
- 渲染转换层：`RedConverter`（`src/converter.ts`）
- 样式系统层：`ThemeManager` + 主题 JSON（`src/themeManager.ts` + `src/templates/*.json`）
- 模板结构层：`ImgTemplateManager` + 模板类（`src/imgTelplate/*.ts`）
- 功能服务层：导出/复制/背景/打赏（`downloadManager`、`clipboardManager`、`backgroundManager`、`donateManager`）
- 设置管理层：`SettingsManager` + 设置页与 Modal（`src/settings/*.ts`）

### 3.2 核心对象关系
1. `RedPlugin.onload()` 初始化 `SettingsManager`、`ThemeManager`、`RedConverter`、`DonateManager`。
2. 注册 `RedView` 视图和命令/按钮。
3. 打开视图后，`RedView` 负责工具栏、预览区、底部操作栏和监听器。
4. 预览更新时：Markdown 渲染 -> 内容切分转换 -> 模板渲染 -> 主题样式注入 -> 背景应用。

## 4. 核心流程（从文档到图片）

### 4.1 触发链路
- 文件打开：`workspace.on('file-open')`
- 文件修改：`vault.on('modify')`（500ms 防抖）
- 手动操作：切换模板、主题、字体、字号、背景

### 4.2 渲染流程
1. `RedView.updatePreview()` 读取当前 Markdown 文件。
2. 调用 `MarkdownRenderer.render()` 得到标准 HTML。
3. `RedConverter.formatContent()`：
   - 按设置项 `headingLevel`（h1/h2）查找分段标题。
   - 以标题为单位拆分成 `.red-content-section`。
   - 支持在标题内容中用 `---`（渲染后为 `HR`）进行分页。
   - 对代码块、图片、链接、表格、脚注等元素追加插件样式类或结构。
4. `ImgTemplateManager.applyTemplate()`：
   - 注入页眉/页脚结构（例如默认模板、备忘录模板）。
   - 绑定头像/昵称/页脚文本等可编辑行为。
5. `ThemeManager.applyTheme()`：
   - 将主题 JSON 中的样式字符串逐项应用到 DOM 节点。
   - 统一套用字体和字号。
6. 若配置了背景图，`BackgroundManager.applyBackgroundStyles()` 将背景样式注入 `.red-image-preview`。
7. 更新分页导航与按钮可用状态。

## 5. 核心模块详解

### 5.1 插件入口：`src/main.ts`
职责：生命周期管理与组件装配。
- 加载设置与主题系统。
- 初始化转换器、打赏模块。
- 注册视图 `VIEW_TYPE_RED`。
- 注册命令 `open-mp-preview` 和 Ribbon 图标。
- 注册设置页 `RedSettingTab`。

### 5.2 主视图：`src/view.ts`
职责：UI 组织 + 交互控制 + 预览调度。
- 顶部：锁定、模板选择、主题选择、字体选择、字号调节。
- 中部：预览区 + 左右翻页 + 页码指示。
- 底部：帮助、背景设置、关于作者、单页导出、批量导出。
- 状态控制：
  - `isPreviewLocked` 控制实时刷新。
  - `currentImageIndex` 控制当前可视页。
  - 根据内容有效性禁用/启用控件。

### 5.3 转换器：`src/converter.ts`
职责：把 Obsidian Markdown 渲染结果转成“可截图”的结构化页面。
- 校验是否有分段标题；无标题时显示引导提示。
- 标题切片 + 水平线分页。
- 代码块增强：添加仿 macOS 三色点、移除原复制按钮。
- 图片处理：将内部嵌入替换为可导出的 `<img>` 资源路径。
- 元素语义增强：blockquote、table、footnote、task-list 等统一打类。

### 5.4 主题系统：`src/themeManager.ts` + `src/templates/*.json`
职责：提供可配置的样式令牌并映射到页面 DOM。
- 主题对象 `Theme` 定义完整样式 schema（页眉、页脚、标题、段落、列表、代码、表格等）。
- 内置主题从 JSON 导入（`src/templates/index.ts`）。
- `applyTheme()` 将字符串样式切分并注入对应节点。
- 支持运行时字体(`setFont`)与字号(`setFontSize`)覆盖。

### 5.5 模板系统：`src/imgTemplateManager.ts` + `src/imgTelplate/*.ts`
职责：决定页面结构与业务信息（header/footer）的生成方式。
- 当前实现模板：
  - `DefaultTemplate`：头像、用户名、ID、时间、页脚文案。
  - `NotesTemplate`：备忘录式顶部栏，默认无页脚。
- 模板与主题分离：模板管结构，主题管样式。

### 5.6 设置系统：`src/settings/settings.ts`
职责：插件配置持久化与主题/字体管理。
- 加载：`loadData()`，并在首次加载时导入内置主题。
- 保存：`saveData()`。
- 设置项覆盖：`updateSettings()`。
- 扩展资源管理：自定义主题增删改、字体增删改。

关键配置包括：
- 内容分割：`headingLevel`（h1/h2）
- 视觉：`themeId`、`templateId`、`fontFamily`、`fontSize`
- 用户信息：头像、用户名、ID、备注标题、页脚文字
- 开关：显示时间、显示页脚
- 背景：`backgroundSettings`（url/scale/position）
- 打赏提示计数：`donateCount`、`lastDonatePrompt`

### 5.7 设置 UI：`src/settings/SettingTab.ts` 等
职责：在 Obsidian 设置页提供交互式配置入口。
- 基础设置：标题级别、字体管理。
- 主题设置：显示/隐藏、预览、编辑、删除、新建。
- 相关弹窗：
  - `CreateThemeModal.ts`：可视化编辑主题样式（分区折叠、颜色选择、文本输入）。
  - `ThemePreviewModal.ts`：主题即时预览。
  - `CreateFontModal.ts`：新增/编辑字体。
  - `ConfirmModal.ts`：删除确认。

### 5.8 导出与复制
- `src/downloadManager.ts`
  - 单页导出 PNG。
  - 全部页导出 ZIP（遍历 section，逐页切换可见性截图）。
- `src/clipboardManager.ts`
  - 将当前预览页复制到系统剪贴板（优先 Blob，失败回退 Canvas）。

### 5.9 背景与打赏
- `src/backgroundManager.ts`：背景样式应用/清理。
- `src/modals/BackgroundSettingModal.ts`：背景选择、上传、缩放、拖拽定位、确认回写。
- `src/donateManager.ts`：关于作者与打赏弹窗。

## 6. 样式组织
CSS 主入口：`src/styles/index.css`，按场景拆分：
- `view/*`：主视图布局、工具栏、弹窗
- `template/*`：模板特定样式
- `theme/*`：主题相关样式
- `element/*`：Markdown 元素基础样式
- `settings/*`：设置页与主题编辑弹窗

## 7. 数据模型与扩展点

### 7.1 主题模型扩展
只要遵守 `Theme.styles` schema，即可通过 JSON 或 UI 新增主题。

### 7.2 模板扩展
实现 `ImgTemplate` 接口后在 `ImgTemplateManager.initializeTemplates()` 注册即可。

### 7.3 导出能力扩展
当前导出依赖 DOM 截图；如需更高质量/更快性能，可扩展：
- 渲染分辨率参数化
- 异步导出队列
- 导出任务进度提示

## 8. 实现特点与注意事项
- 渲染职责分离较清晰：内容转换、模板结构、主题样式三层解耦。
- 通过设置持久化保证重启后还原。
- 导出与复制均提供“主路径 + 回退路径”，提升成功率。
- 当前代码中版本信息存在双源（`package.json` 与 `manifest.json`），发布时以 `manifest.json` 为准，建议保持同步。

## 9. 快速源码导航
- 生命周期入口：`src/main.ts`
- 主视图：`src/view.ts`
- 内容切分转换：`src/converter.ts`
- 主题系统：`src/themeManager.ts`、`src/templates/index.ts`
- 模板系统：`src/imgTemplateManager.ts`、`src/imgTelplate/defaultTemplate.ts`、`src/imgTelplate/notesTemplate.ts`
- 设置与持久化：`src/settings/settings.ts`、`src/settings/SettingTab.ts`
- 导出复制：`src/downloadManager.ts`、`src/clipboardManager.ts`
- 背景：`src/backgroundManager.ts`、`src/modals/BackgroundSettingModal.ts`
- 打赏：`src/donateManager.ts`

