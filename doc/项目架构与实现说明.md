# Note to RED 项目架构与实现说明

## 1. 项目定位
Note to RED 是一个 Obsidian 桌面端插件，用于将 Markdown 笔记按标题切分并渲染为小红书风格图片，支持主题、模板、字体、背景、封面排版、单页导出、批量导出与复制。

- 插件入口：`src/main.ts`
- 视图类型：`note-to-red`
- 平台：桌面端（`manifest.json` 中 `isDesktopOnly: true`）

## 2. 技术栈与构建

### 2.1 技术栈
- TypeScript
- Obsidian Plugin API
- esbuild（脚本与样式打包）
- html-to-image（截图导出）
- jszip（批量导出压缩）

### 2.2 构建输出
- `src/main.ts` -> `main.js`
- `src/styles/index.css` -> `styles.css`
- 开发：`npm run dev`
- 构建：`npm run build`

### 2.3 发布打包
`build.sh` 将 `main.js`、`manifest.json`、`styles.css`、`assets/` 打包为 zip。

## 3. 运行时架构

### 3.1 分层
- 生命周期层：`RedPlugin`（`src/main.ts`）
- 视图层：`RedView`（`src/view.ts`）
- 转换层：`RedConverter`（`src/converter.ts`）
- 模板层：`ImgTemplateManager` + `src/imgTelplate/*.ts`
- 样式层：`ThemeManager` + `src/templates/*.json`
- 服务层：`downloadManager`、`clipboardManager`、`backgroundManager`、`donateManager`
- 设置层：`SettingsManager` + `src/settings/*.ts`

### 3.2 关键对象关系
1. `RedPlugin.onload()` 初始化设置、主题、转换器并注册视图。
2. `RedView` 负责 UI 与事件监听（file-open/modify）。
3. `updatePreview()` 执行渲染链：
   Markdown -> 转换 section -> 模板注入 -> 主题应用 -> 背景应用。

## 4. 核心流程

### 4.1 渲染流程
1. `MarkdownRenderer.render()` 输出 HTML。
2. `RedConverter.formatContent()` 按 `headingLevel`（h1/h2）拆分 `.red-content-section`。
3. 当开启封面导出时：
   - 从文档首个 `h1` 生成封面 section（`red-cover-section`）。
   - 封面与正文使用同一 section 生成逻辑。
   - 若当前分割级别是 `h1`，正文列表会跳过同一个首 `h1`，避免重复。
4. `ImgTemplateManager.applyTemplate()` 注入页眉/页脚结构。
5. `ThemeManager.applyTheme()` 应用主题与动态样式（含页眉/封面个性化）。

### 4.2 导出流程
- 下载当前页：`DownloadManager.downloadSingleImage()`
  - 直接截图当前显示 section。
  - 封面导出使用该按钮完成（切换到封面页后下载）。
- 导出全部页：`DownloadManager.downloadAllImages()`
  - 逐页切换 section 可见性并截图打包 ZIP。
  - 按 `coverExportSettings.includeInBatchExport` 控制是否包含封面。

## 5. 模块实现详解

### 5.1 `src/main.ts`
- 加载 `SettingsManager`、`ThemeManager`。
- 初始化 `RedConverter`、`DonateManager`。
- 注册视图、命令、Ribbon 图标、设置页。

### 5.2 `src/view.ts`
- 顶部：锁定、模板、主题、字体、字号。
- 中部：预览区 + 导航按钮 + 页码。
- 底部：帮助、背景、关于作者、下载当前页、导出全部页。
- 已移除独立“导出封面图”按钮，封面通过“下载当前页”导出。

### 5.3 `src/converter.ts`
- 内容有效性判断：正文有效或封面有效（开启封面且存在 `h1`）即有效。
- section 构建：
  - 普通 section：按标题和 `HR` 分页。
  - 封面 section：使用首个 `h1`，结构与正文 section 一致，仅额外标记 `red-cover-section`。
- 元素处理：代码块、链接、图片、表格、脚注、任务列表、引用等样式增强。

### 5.4 `src/themeManager.ts`
- `applyTheme()` 应用主题 JSON 字符串样式。
- 页眉扩展：
  - 支持 `showHeader` 关闭页眉。
  - 支持页眉背景、间距、头像尺寸、用户名/ID/时间字号自定义。
- 封面排版扩展：只允许这些维度：
  - 文字颜色 `textColor`
  - 字号 `fontSize`
  - 字重 `fontWeight`
  - 字体 `fontFamily`
  - 对齐 `textAlign`
  - 间距 `padding`
- 明确不支持封面背景颜色与封面尺寸定制。

### 5.5 `src/imgTemplateManager.ts` 与 `src/imgTelplate/*.ts`
- 模板管理器注册并切换模板。
- 当前模板：
  - `DefaultTemplate`
  - `NotesTemplate`
- 模板负责结构，主题负责样式。

### 5.6 `src/settings/settings.ts`
关键配置：
- 基础：`templateId`、`themeId`、`fontFamily`、`fontSize`
- 分割：`headingLevel`
- 用户信息：头像、用户名、ID、备忘录标题、页脚文本
- 开关：`showTime`、`showHeader`、`showFooter`
- 页眉自定义：`headerCustomSettings`
- 背景：`backgroundSettings`
- 封面排版：`coverExportSettings`
  - `enabled`
  - `includeInBatchExport`
  - `textColor`
  - `fontSize`
  - `fontWeight`
  - `fontFamily`
  - `padding`
  - `textAlign`
  - `fileNamePrefix`

### 5.7 `src/settings/SettingTab.ts`
设置页结构（与当前实现一致）：
- `基本设置`
- `主题设置`
  - 同级折叠分组 `显示设置`
  - 同级折叠分组 `封面排版`（默认折叠）
- 主题显示/隐藏列表与主题管理区域。

### 5.8 `src/downloadManager.ts`
- 单页导出 PNG。
- 全部页导出 ZIP。
- 导出时同时维护 `red-section-active` 与 `red-section-visible/hidden`，避免截图空白。

### 5.9 `src/clipboardManager.ts`
- 复制当前页到剪贴板。
- 主路径失败时回退 canvas 方案。

### 5.10 背景与打赏
- `src/backgroundManager.ts` 与 `src/modals/BackgroundSettingModal.ts`：背景图选择、缩放、拖拽。
- `src/donateManager.ts`：作者信息与赞助弹窗。

## 6. 样式组织
样式入口：`src/styles/index.css`。
按职责拆分：`view/`、`theme/`、`template/`、`element/`、`settings/`。

## 7. 扩展建议
- 新模板：实现 `ImgTemplate` 后在 `ImgTemplateManager` 注册。
- 新主题：按 `Theme.styles` schema 扩展 JSON。
- 导出增强：进度提示、任务队列、失败重试。

## 8. 快速导航
- 插件入口：`src/main.ts`
- 主视图：`src/view.ts`
- 转换器：`src/converter.ts`
- 主题系统：`src/themeManager.ts`、`src/templates/index.ts`
- 模板系统：`src/imgTemplateManager.ts`、`src/imgTelplate/defaultTemplate.ts`、`src/imgTelplate/notesTemplate.ts`
- 设置系统：`src/settings/settings.ts`、`src/settings/SettingTab.ts`
- 导出复制：`src/downloadManager.ts`、`src/clipboardManager.ts`
- 背景：`src/backgroundManager.ts`、`src/modals/BackgroundSettingModal.ts`
- 打赏：`src/donateManager.ts`
